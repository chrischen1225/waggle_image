#!/bin/bash

###                              ###
###  Script for chroot execution ###
###                              ###

set -x
set -e

###locale
locale-gen "en_US.UTF-8"
dpkg-reconfigure locales

### timezone 
echo "Etc/UTC" > /etc/timezone 
dpkg-reconfigure --frontend noninteractive tzdata

# because of "Failed to fetch http://ports.ubuntu.com/... ...Hash Sum mismatch"
#rm -rf /var/lib/apt/lists/*
touch -t 1501010000 /var/lib/apt/lists/*
rm -f /var/lib/apt/lists/partial/*
apt-get clean
apt-key update
apt-get update

# disable software update and new release checks and messages
# (don't want the node connecting to anything other than the beehive server)
apt-get remove --yes update-manager-core
apt-get remove --yes ubuntu-release-upgrader-core
cat /etc/pam.d/sshd | sed 's/^\(..*pam_motd..*\)/# \1/' > /tmp/sshd
mv /tmp/sshd /etc/pam.d/sshd

mkdir -p /etc/waggle/
echo "10.31.81.10" > /etc/waggle/node_controller_host

# Packages are installed via waggle_image/install_dependencies.sh
set -e


# Every waggle image needs this repository
mkdir -p /usr/lib/waggle/
cd /usr/lib/waggle/
if [ ! -e waggle_image ] ; then
  # this repo should already have been checked out earlier.
  git clone https://github.com/waggle-sensor/waggle_image.git
fi
cd waggle_image

./scripts/remove_packages.sh
./install_dependencies.sh
./configure



### get plugin_manager repo
cd /usr/lib/waggle/
git clone --recursive https://github.com/waggle-sensor/plugin_manager.git
sleep 1
cd /usr/lib/waggle/plugin_manager/
scripts/install_dependencies.sh
./configure

# make sure serial console requires password
sed -i -e 's:exec /bin/login -f root:exec /bin/login:' /bin/auto-root-login


